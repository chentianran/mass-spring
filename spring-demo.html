<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spring Animation Demo - Mass-Spring System</title>
  <style>
    :root {
      --color-primary: #AA1111;
      --color-primary-hover: #CC1111;
      --color-primary-shadow: rgba(170, 17, 17, 0.3);
      --color-text: #555;
      --color-heading: #333;
      --color-border: #dee2e6;
      --color-background: #ffffff;
      --color-bg-light: #f8f9fa;
      --color-gray: #666;
      --color-gray-dark: #555;
      --color-gray-darker: #333;
      --color-gray-light: #777;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Montserrat', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--color-background);
      color: var(--color-text);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      background: var(--color-background);
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      max-width: 900px;
      width: 100%;
      border: 1px solid #e0e0e0;
    }

    .content {
      display: flex;
      flex-wrap: wrap;
    }

    .canvas-container {
      flex: 1;
      min-width: 400px;
      background: var(--color-bg-light);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      gap: 15px;
    }

    canvas {
      border: 2px solid var(--color-border);
      border-radius: 10px;
      background: var(--color-background);
      display: block;
    }

    #springCanvas {
      width: 400px;
      height: 400px;
    }

    #graphCanvas {
      width: 400px;
      height: 200px;
    }

    #phaseCanvas {
      width: 400px;
      height: 200px;
    }

    .controls {
      flex: 1;
      min-width: 300px;
      padding: 30px;
    }

    .control-group {
      margin-bottom: 25px;
    }

    .control-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--color-heading);
      font-size: 0.95em;
    }

    .control-group input[type="range"] {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: var(--color-border);
      outline: none;
      -webkit-appearance: none;
    }

    .control-group input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--color-primary);
      cursor: pointer;
    }

    .control-group input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--color-primary);
      cursor: pointer;
      border: none;
    }

    .value-display {
      display: inline-block;
      margin-left: 10px;
      color: var(--color-primary);
      font-weight: 600;
      min-width: 60px;
    }

    .scenario-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 20px;
    }

    .scenario-btn {
      padding: 12px 20px;
      border: 2px solid var(--color-primary);
      background: var(--color-background);
      color: var(--color-primary);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 0.9em;
    }

    .scenario-btn:hover {
      background: var(--color-primary);
      color: var(--color-background);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--color-primary-shadow);
    }

    .scenario-btn:active {
      transform: translateY(0);
    }

    .control-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 15px;
    }

    .control-btn {
      padding: 15px;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .reset-btn {
      background: var(--color-gray-dark);
      box-shadow: 0 2px 8px rgba(85, 85, 85, 0.2);
    }

    .reset-btn:hover {
      background: var(--color-gray-darker);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(85, 85, 85, 0.3);
    }

    .reset-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(85, 85, 85, 0.2);
    }

    .play-pause-btn {
      background: var(--color-primary);
      box-shadow: 0 2px 8px rgba(170, 17, 17, 0.2);
    }

    .play-pause-btn:hover {
      background: var(--color-primary-hover);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--color-primary-shadow);
    }

    .play-pause-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(170, 17, 17, 0.2);
    }

    .play-pause-btn.paused {
      background: var(--color-gray);
      box-shadow: 0 2px 8px rgba(102, 102, 102, 0.2);
    }

    .play-pause-btn.paused:hover {
      background: var(--color-gray-light);
      box-shadow: 0 4px 12px rgba(102, 102, 102, 0.3);
    }

    .info-panel {
      background: var(--color-bg-light);
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      font-size: 0.9em;
    }

    .info-panel h3 {
      margin: 0 0 10px 0;
      color: var(--color-heading);
      font-size: 1em;
    }

    .info-panel p {
      margin: 5px 0;
      color: var(--color-text);
    }

    .info-panel .value {
      color: var(--color-primary);
      font-weight: 600;
    }

    /* Additional CSS classes for inline-styled elements */
    .forcing-select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 2px solid var(--color-border);
      font-size: 0.95em;
      cursor: pointer;
    }

    .forcing-param-label {
      margin-bottom: 8px;
      display: block;
      font-weight: 600;
      color: var(--color-heading);
      font-size: 0.95em;
    }

    .forcing-param-slider {
      width: 100%;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="content">
      <div class="canvas-container">
        <canvas id="springCanvas" width="400" height="400"></canvas>
        <canvas id="graphCanvas" width="400" height="200"></canvas>
        <canvas id="phaseCanvas" width="400" height="200"></canvas>
      </div>

      <div class="controls">
        <div class="control-group">
          <label>
            Mass (m):
            <span class="value-display" id="mass-value">1.00 kg</span>
          </label>
          <input type="range" id="mass-slider" min="0.1" max="5" step="0.1" value="1">
        </div>

        <div class="control-group">
          <label>
            Damping (b):
            <span class="value-display" id="damping-value">0.10 N路s/m</span>
          </label>
          <input type="range" id="damping-slider" min="0" max="2" step="0.05" value="0.1">
        </div>

        <div class="control-group">
          <label>
            Spring Constant (k):
            <span class="value-display" id="spring-value">1.00 N/m</span>
          </label>
          <input type="range" id="spring-slider" min="0.1" max="5" step="0.1" value="1">
        </div>

        <div class="control-group">
          <label>
            Initial Position (y):
            <span class="value-display" id="y0-value">1.00 m</span>
          </label>
          <input type="range" id="y0-slider" min="-2" max="2" step="0.1" value="1">
        </div>

        <div class="control-group">
          <label>
            Initial Velocity (v):
            <span class="value-display" id="v0-value">0.00 m/s</span>
          </label>
          <input type="range" id="v0-slider" min="-5" max="5" step="0.1" value="0">
        </div>

        <div class="control-group">
          <label>
            Forcing Function f(t):
          </label>
          <select id="forcing-select" class="forcing-select">
            <option value="none">None (free oscillation)</option>
            <option value="constant">Constant (gravity-like)</option>
            <option value="cosine">Cosine: a路cos(t)</option>
            <option value="step">Step function</option>
            <option value="impulse">Impulse: a路未(t - t)</option>
          </select>
        </div>

        <div class="control-group" id="forcing-params-container" style="display: none;">
          <!-- Constant force parameter -->
          <div id="constant-params" style="display: none;">
            <label>
              Force (g):
              <span class="value-display" id="force-value">1.00 N</span>
            </label>
            <input type="range" id="force-slider" min="-10" max="10" step="0.1" value="1">
          </div>

          <!-- Cosine parameters -->
          <div id="cosine-params" style="display: none;">
            <label class="forcing-param-label">
              Amplitude (a):
              <span class="value-display" id="amplitude-value">1.00 N</span>
            </label>
            <input type="range" id="amplitude-slider" min="0" max="5" step="0.1" value="1" class="forcing-param-slider">

            <label class="forcing-param-label">
              Frequency (/2):
              <span class="value-display" id="frequency-value">1.00 Hz</span>
            </label>
            <input type="range" id="frequency-slider" min="0.1" max="5" step="0.1" value="1">
          </div>

          <!-- Step function parameters -->
          <div id="step-params" style="display: none;">
            <label class="forcing-param-label">
              Amplitude:
              <span class="value-display" id="step-amplitude-value">1.00 N</span>
            </label>
            <input type="range" id="step-amplitude-slider" min="-10" max="10" step="0.1" value="1" class="forcing-param-slider">

            <label class="forcing-param-label">
              Step Time:
              <span class="value-display" id="step-time-value">1.00 s</span>
            </label>
            <input type="range" id="step-time-slider" min="0" max="10" step="0.1" value="1">
          </div>

          <!-- Impulse parameters -->
          <div id="impulse-params" style="display: none;">
            <label class="forcing-param-label">
              Impulse Magnitude (a):
              <span class="value-display" id="impulse-amplitude-value">1.00 N路s</span>
            </label>
            <input type="range" id="impulse-amplitude-slider" min="-10" max="10" step="0.1" value="1" class="forcing-param-slider">

            <label class="forcing-param-label">
              Impulse Time (t):
              <span class="value-display" id="impulse-time-value">1.00 s</span>
            </label>
            <input type="range" id="impulse-time-slider" min="0" max="10" step="0.1" value="1">
          </div>
        </div>

        <div class="scenario-buttons">
          <button class="scenario-btn" data-scenario="shm">Simple Harmonic</button>
          <button class="scenario-btn" data-scenario="underdamped">Underdamped</button>
          <button class="scenario-btn" data-scenario="critical">Critical Damping</button>
          <button class="scenario-btn" data-scenario="overdamped">Overdamped</button>
        </div>

        <div class="control-buttons">
          <button class="control-btn reset-btn" id="reset-btn"> Reset</button>
          <button class="control-btn play-pause-btn" id="play-pause-btn">革 Pause</button>
        </div>

        <div class="info-panel">
          <h3>System Properties</h3>
          <p>Natural Frequency: <span class="value" id="freq-display">0.159 Hz</span></p>
          <p>Damping Regime: <span class="value" id="regime-display">underdamped</span></p>
          <p>Damping Ratio (味): <span class="value" id="zeta-display">0.100</span></p>
          <p>Quality Factor (Q): <span class="value" id="q-display">5.00</span></p>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { MassSpringSystem } from './src/physics/MassSpringSystem.js';
    import { SpringAnimator } from './src/rendering/SpringAnimator.js';
    import { GraphPlotter } from './src/rendering/GraphPlotter.js';
    import { PhasePortrait } from './src/rendering/PhasePortrait.js';
    import { presets } from './src/physics/forcingFunctions.js';

    // Constants
    const CANVAS_WIDTH = 400;
    const CANVAS_HEIGHT_SPRING = 400;
    const CANVAS_HEIGHT_GRAPH = 200;
    const TARGET_FPS = 60;
    const FRAME_TIME_MS = 1000 / TARGET_FPS;
    const TIME_STEP = FRAME_TIME_MS / 1000;

    // Get canvases and contexts
    const springCanvas = document.getElementById('springCanvas');
    const springCtx = springCanvas.getContext('2d');

    const graphCanvas = document.getElementById('graphCanvas');
    const graphCtx = graphCanvas.getContext('2d');

    const phaseCanvas = document.getElementById('phaseCanvas');
    const phaseCtx = phaseCanvas.getContext('2d');

    // Create physics system
    const system = new MassSpringSystem({
      m: 1.0,
      b: 0.1,
      k: 1.0,
      y0: 1.0,
      v0: 0.0
    });

    // Create animator with system parameters
    const animator = new SpringAnimator({
      width: CANVAS_WIDTH,
      height: CANVAS_HEIGHT_SPRING,
      systemParams: {
        m: 1.0,
        b: 0.1,
        k: 1.0
      }
    });

    // Create graph plotter
    const grapher = new GraphPlotter({
      width: CANVAS_WIDTH,
      height: CANVAS_HEIGHT_GRAPH
    });

    // Create phase portrait plotter
    const phasePlotter = new PhasePortrait({
      width: CANVAS_WIDTH,
      height: CANVAS_HEIGHT_GRAPH
    });

    // Data storage for graph
    let graphData = [];

    // Data storage for phase portrait
    let phaseData = [];

    // Animation state
    let isPlaying = true;

    // Store initial conditions for graph/phase scaling
    let initialY0 = 1.0;
    let initialV0 = 0.0;

    // Get controls
    const massSlider = document.getElementById('mass-slider');
    const dampingSlider = document.getElementById('damping-slider');
    const springSlider = document.getElementById('spring-slider');
    const y0Slider = document.getElementById('y0-slider');
    const v0Slider = document.getElementById('v0-slider');

    // Forcing function controls
    const forcingSelect = document.getElementById('forcing-select');
    const forcingParamsContainer = document.getElementById('forcing-params-container');
    const constantParams = document.getElementById('constant-params');
    const cosineParams = document.getElementById('cosine-params');
    const stepParams = document.getElementById('step-params');
    const impulseParams = document.getElementById('impulse-params');

    // Forcing function parameter sliders
    const forceSlider = document.getElementById('force-slider');
    const amplitudeSlider = document.getElementById('amplitude-slider');
    const frequencySlider = document.getElementById('frequency-slider');
    const stepAmplitudeSlider = document.getElementById('step-amplitude-slider');
    const stepTimeSlider = document.getElementById('step-time-slider');
    const impulseAmplitudeSlider = document.getElementById('impulse-amplitude-slider');
    const impulseTimeSlider = document.getElementById('impulse-time-slider');

    // Update forcing parameter displays
    function updateForcingDisplays() {
      document.getElementById('force-value').textContent = `${parseFloat(forceSlider.value).toFixed(2)} N`;
      document.getElementById('amplitude-value').textContent = `${parseFloat(amplitudeSlider.value).toFixed(2)} N`;
      document.getElementById('frequency-value').textContent = `${parseFloat(frequencySlider.value).toFixed(2)} Hz`;
      document.getElementById('step-amplitude-value').textContent = `${parseFloat(stepAmplitudeSlider.value).toFixed(2)} N`;
      document.getElementById('step-time-value').textContent = `${parseFloat(stepTimeSlider.value).toFixed(2)} s`;
      document.getElementById('impulse-amplitude-value').textContent = `${parseFloat(impulseAmplitudeSlider.value).toFixed(2)} N路s`;
      document.getElementById('impulse-time-value').textContent = `${parseFloat(impulseTimeSlider.value).toFixed(2)} s`;
    }

    // Show/hide forcing parameter controls based on selected forcing function
    function updateForcingControls() {
      const selectedForcing = forcingSelect.value;

      // Hide all parameter sections
      constantParams.style.display = 'none';
      cosineParams.style.display = 'none';
      stepParams.style.display = 'none';
      impulseParams.style.display = 'none';

      // Show container and appropriate parameters
      if (selectedForcing === 'none') {
        forcingParamsContainer.style.display = 'none';
        system.setForcing('none', {});
      } else {
        forcingParamsContainer.style.display = 'block';

        if (selectedForcing === 'constant') {
          constantParams.style.display = 'block';
          system.setForcing('constant', {
            force: parseFloat(forceSlider.value)
          });
        } else if (selectedForcing === 'cosine') {
          cosineParams.style.display = 'block';
          system.setForcing('cosine', {
            amplitude: parseFloat(amplitudeSlider.value),
            frequency: parseFloat(frequencySlider.value)
          });
        } else if (selectedForcing === 'step') {
          stepParams.style.display = 'block';
          system.setForcing('step', {
            amplitude: parseFloat(stepAmplitudeSlider.value),
            stepTime: parseFloat(stepTimeSlider.value)
          });
        } else if (selectedForcing === 'impulse') {
          impulseParams.style.display = 'block';
          system.setForcing('impulse', {
            amplitude: parseFloat(impulseAmplitudeSlider.value),
            impulseTime: parseFloat(impulseTimeSlider.value)
          });
        }
      }

      updateForcingDisplays();
    }

    // Update displays
    function updateDisplays() {
      document.getElementById('mass-value').textContent = `${parseFloat(massSlider.value).toFixed(2)} kg`;
      document.getElementById('damping-value').textContent = `${parseFloat(dampingSlider.value).toFixed(2)} N路s/m`;
      document.getElementById('spring-value').textContent = `${parseFloat(springSlider.value).toFixed(2)} N/m`;
      document.getElementById('y0-value').textContent = `${parseFloat(y0Slider.value).toFixed(2)} m`;
      document.getElementById('v0-value').textContent = `${parseFloat(v0Slider.value).toFixed(2)} m/s`;

      const props = system.getSystemProperties();
      document.getElementById('freq-display').textContent = `${props.f0.toFixed(3)} Hz`;
      document.getElementById('regime-display').textContent = props.regime;
      document.getElementById('zeta-display').textContent = props.zeta.toFixed(3);
      document.getElementById('q-display').textContent = props.Q.toFixed(2);
    }

    // Update system parameters
    function updateParameters() {
      const params = {
        m: parseFloat(massSlider.value),
        b: parseFloat(dampingSlider.value),
        k: parseFloat(springSlider.value)
      };
      system.setParameters(params);
      animator.setSystemParams(params);
      updateDisplays();
    }

    // Reset animation with new initial conditions
    function resetAnimation() {
      const y0 = parseFloat(y0Slider.value);
      const v0 = parseFloat(v0Slider.value);

      // Store initial conditions for graph/phase scaling
      initialY0 = y0;
      initialV0 = v0;

      // Get current forcing function to preserve it
      const forcing = system.getForcing();

      // Reset the system with new initial conditions
      system.reset();
      system.setParameters({
        m: parseFloat(massSlider.value),
        b: parseFloat(dampingSlider.value),
        k: parseFloat(springSlider.value),
        y0: y0,
        v0: v0
      });

      // Restore forcing function
      system.setForcing(forcing.name, forcing.params);

      // Reset graph data and phase data
      graphData = [];
      phaseData = [];

      // Resume animation if paused
      if (!isPlaying) {
        togglePlayPause();
      }

      updateDisplays();
    }

    // Toggle play/pause
    function togglePlayPause() {
      isPlaying = !isPlaying;
      const btn = document.getElementById('play-pause-btn');
      if (isPlaying) {
        btn.textContent = '革 Pause';
        btn.classList.remove('paused');
      } else {
        btn.textContent = '讹 Play';
        btn.classList.add('paused');
      }
    }

    // Scenario presets
    function setScenario(scenario) {
      switch (scenario) {
        case 'shm':
          massSlider.value = 1.0;
          dampingSlider.value = 0.0;
          springSlider.value = 1.0;
          break;
        case 'underdamped':
          massSlider.value = 1.0;
          dampingSlider.value = 0.2;
          springSlider.value = 1.0;
          break;
        case 'critical':
          massSlider.value = 1.0;
          dampingSlider.value = 2.0;
          springSlider.value = 1.0;
          break;
        case 'overdamped':
          massSlider.value = 1.0;
          dampingSlider.value = 5.0;
          springSlider.value = 1.0;
          break;
      }
      system.reset();
      system.setParameters({
        m: parseFloat(massSlider.value),
        b: parseFloat(dampingSlider.value),
        k: parseFloat(springSlider.value)
      });

      // Reset graph data and phase data
      graphData = [];
      phaseData = [];

      updateDisplays();
    }

    // Event listeners
    massSlider.addEventListener('input', () => {
      updateParameters();
    });

    dampingSlider.addEventListener('input', () => {
      updateParameters();
    });

    springSlider.addEventListener('input', () => {
      updateParameters();
    });

    y0Slider.addEventListener('input', () => {
      updateDisplays();
    });

    v0Slider.addEventListener('input', () => {
      updateDisplays();
    });

    // Helper functions for forcing function updates
    function updateConstantForcing() {
      system.setForcing('constant', {
        force: parseFloat(forceSlider.value)
      });
      updateForcingDisplays();
    }

    function updateCosineForcing() {
      system.setForcing('cosine', {
        amplitude: parseFloat(amplitudeSlider.value),
        frequency: parseFloat(frequencySlider.value)
      });
      updateForcingDisplays();
    }

    function updateStepForcing() {
      system.setForcing('step', {
        amplitude: parseFloat(stepAmplitudeSlider.value),
        stepTime: parseFloat(stepTimeSlider.value)
      });
      updateForcingDisplays();
    }

    function updateImpulseForcing() {
      system.setForcing('impulse', {
        amplitude: parseFloat(impulseAmplitudeSlider.value),
        impulseTime: parseFloat(impulseTimeSlider.value)
      });
      updateForcingDisplays();
    }

    // Forcing function event listeners
    forcingSelect.addEventListener('change', updateForcingControls);
    forceSlider.addEventListener('input', updateConstantForcing);
    amplitudeSlider.addEventListener('input', updateCosineForcing);
    frequencySlider.addEventListener('input', updateCosineForcing);
    stepAmplitudeSlider.addEventListener('input', updateStepForcing);
    stepTimeSlider.addEventListener('input', updateStepForcing);
    impulseAmplitudeSlider.addEventListener('input', updateImpulseForcing);
    impulseTimeSlider.addEventListener('input', updateImpulseForcing);

    // Button event listeners
    document.getElementById('reset-btn').addEventListener('click', resetAnimation);
    document.getElementById('play-pause-btn').addEventListener('click', togglePlayPause);

    // Scenario button event listeners
    document.querySelectorAll('.scenario-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const scenario = btn.dataset.scenario;
        setScenario(scenario);
      });
    });

    // Animation loop
    let lastTime = performance.now();

    function animate(currentTime) {
      const elapsed = currentTime - lastTime;

      if (elapsed >= FRAME_TIME_MS) {
        if (isPlaying) {
          // Step physics
          const state = system.step(TIME_STEP);

          // Add data point to graph and phase portrait
          graphData.push({ t: state.t, y: state.y });
          phaseData.push({ y: state.y, v: state.v });
        }

        // Always render (even when paused, to show current state)
        const state = system.getState();

        // Get forcing function info for the graph and animator
        const forcingData = system.getForcing();
        const forcingInfo = {
          name: forcingData.name,
          fn: presets[forcingData.name],
          params: forcingData.params
        };

        // Calculate current forcing value for acceleration arrow
        const currentForce = forcingInfo.fn(state.t, forcingInfo.params);

        animator.draw(springCtx, state, currentForce);
        grapher.draw(graphCtx, graphData, initialY0, forcingInfo);
        phasePlotter.draw(phaseCtx, phaseData, initialY0, initialV0);

        lastTime = currentTime;
      }

      requestAnimationFrame(animate);
    }

    // Initial display
    updateDisplays();
    updateForcingDisplays();

    // Start animation
    requestAnimationFrame(animate);
  </script>
</body>
</html>
